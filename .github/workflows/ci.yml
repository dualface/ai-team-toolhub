name: ci

on:
  push:
    branches: [main]
  pull_request:

jobs:
  verify:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: toolhub
          POSTGRES_PASSWORD: ci_password
          POSTGRES_DB: toolhub
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U toolhub -d toolhub"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Go test
        env:
          TOOLHUB_TEST_DATABASE_URL: postgres://toolhub:ci_password@127.0.0.1:5432/toolhub?sslmode=disable
        run: go -C toolhub test ./...

      - name: Validate OpenAPI
        run: npx --yes @redocly/cli lint openapi.yaml --skip-rule security-defined --skip-rule info-license --skip-rule info-contact --skip-rule no-server-example.com

      - name: Validate MCP docs generation
        run: |
          go -C toolhub run ./cmd/mcpdocgen > docs/mcp-tools.generated.md
          git diff --exit-code docs/mcp-tools.generated.md

      - name: Build
        run: make build

      - name: Prepare smoke env
        run: |
          mkdir -p secrets data/artifacts data/postgres
          # toolhub runs as non-root user in container; artifact dir must be writable.
          chmod 0777 data/artifacts
          openssl genrsa -out secrets/github_app_private_key.pem 2048
          # bind-mounted key must be readable by non-root process inside container.
          chmod 0644 secrets/github_app_private_key.pem
          cp .env.example .env
          sed -i 's/^POSTGRES_PASSWORD=.*/POSTGRES_PASSWORD=ci_password/' .env
          sed -i 's/^REPO_ALLOWLIST=.*/REPO_ALLOWLIST=ci-owner\/ci-repo/' .env
          sed -i 's/^GITHUB_APP_ID=.*/GITHUB_APP_ID=1/' .env
          sed -i 's|^GITHUB_PRIVATE_KEY_PATH=.*|GITHUB_PRIVATE_KEY_PATH=/run/secrets/github_app_private_key.pem|' .env
          sed -i 's/^TOOL_ALLOWLIST=.*/TOOL_ALLOWLIST=github.issues.create,github.issues.batch_create,github.pr.comment.create,github.pr.get,github.pr.files.list,qa.test,qa.lint,runs.create/' .env
          sed -i 's|^QA_WORKDIR=.*|QA_WORKDIR=.|' .env
          sed -i 's|^QA_TEST_CMD=.*|QA_TEST_CMD=go -C toolhub test ./...|' .env
          sed -i 's|^QA_LINT_CMD=.*|QA_LINT_CMD=go -C toolhub test ./...|' .env
          sed -i 's|^QA_TIMEOUT_SECONDS=.*|QA_TIMEOUT_SECONDS=600|' .env

      - name: Smoke dry-run (HTTP + MCP)
        run: SMOKE_AUTO_START=1 ./scripts/smoke_phase_a5_b.sh

      - name: Teardown
        if: always()
        run: docker compose down -v
